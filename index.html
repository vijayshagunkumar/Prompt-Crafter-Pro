<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptCraft Pro - AI Prompt Engineering Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-color: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1.25rem;
            background-image: 
                radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(30, 41, 59, 0.3) 0px, transparent 50%);
        }

        body.modal-open {
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem;
            transition: filter 0.3s ease;
        }

        body.modal-open .container {
            filter: blur(2px);
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo h1 {
            font-size: 2.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tagline {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 0.625rem;
            flex-wrap: wrap;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #475569;
            border-color: #64748b;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-large {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .btn-reset {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-inspiration {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        /* ===== STEP SECTIONS ===== */
        .step-section {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            margin-bottom: 1.875rem;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: all var(--transition-normal);
        }

        .step-section:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: var(--shadow-lg);
        }

        .step-header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-header h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .step-number {
            background: var(--accent-gradient);
            color: white;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.125rem;
            box-shadow: var(--shadow-md);
        }

        .step-actions {
            display: flex;
            gap: 0.5rem;
        }

        .step-content {
            padding: 1.5625rem;
        }

        /* ===== STEP 1: INPUT SECTION ===== */
        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.9375rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .input-header label {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 600;
            flex: 1;
        }

        .textarea-container {
            position: relative;
            margin-bottom: 1.25rem;
        }

        textarea {
            width: 100%;
            padding: 0.9375rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical;
            transition: all var(--transition-normal);
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .textarea-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.625rem;
        }

        .char-count {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ===== STYLE SELECTOR ===== */
        .style-selector {
            margin-top: 1.25rem;
        }

        .style-selector label {
            display: block;
            margin-bottom: 0.625rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .style-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .style-btn {
            padding: 0.875rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .style-btn:hover:not(.active) {
            background: #475569;
            border-color: #64748b;
            transform: translateY(-2px);
        }

        .style-btn.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ===== STEP 2: PROMPT CONTAINER ===== */
        .prompt-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .prompt-header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            padding: 0.9375rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .model-indicator {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .prompt-actions {
            display: flex;
            gap: 0.5rem;
        }

        .prompt-content {
            padding: 1.5625rem;
            min-height: 200px;
            background: var(--bg-primary);
        }

        .placeholder-text {
            color: var(--text-tertiary);
            text-align: center;
            padding: 2.5rem 1.25rem;
            font-style: italic;
            font-size: 1.125rem;
        }

        .prompt-result {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            border-left: 4px solid var(--accent-primary);
        }

        .prompt-result h4 {
            color: var(--accent-primary);
            margin-bottom: 0.9375rem;
            font-size: 1.125rem;
        }

        .prompt-text {
            color: var(--text-secondary);
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 0.9375rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.9375rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-meta {
            display: flex;
            gap: 1.25rem;
            color: var(--text-tertiary);
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .prompt-footer {
            padding: 1.25rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 1.25rem 1.875rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--text-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: color var(--transition-fast);
        }

        .btn-close:hover {
            color: var(--text-primary);
        }

        .modal-content {
            padding: 1.875rem;
            max-height: calc(90vh - 150px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.25rem 1.875rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: rgba(15, 23, 42, 0.7);
        }

        /* ===== MAXIMIZED MODAL (FIX 1) ===== */
        .maximized-modal {
            max-width: 95%;
            max-height: 95vh;
        }

        .maximized-modal .modal-content {
            max-height: calc(95vh - 150px);
        }

        .maximized-textarea {
            width: 100%;
            min-height: 400px;
            font-size: 1.125rem;
            line-height: 1.8;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1.5625rem;
            border-radius: var(--radius-lg);
            margin: 1.25rem 0;
            resize: vertical;
        }

        .maximized-prompt-content {
            font-size: 1.125rem;
            line-height: 1.8;
            background: var(--bg-primary);
            padding: 1.875rem;
            border-radius: var(--radius-lg);
            margin: 1.25rem 0;
            overflow-x: auto;
        }

        .maximized-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        /* ===== SETTINGS MODAL (FIX 8) ===== */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-header {
            color: var(--text-secondary) !important;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .setting-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all var(--transition-normal);
        }

        .setting-item:hover {
            background: #475569;
            border-color: #64748b;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .setting-description {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin-left: 1.625rem;
        }

        /* ===== INSPIRATION MODAL (FIX 2) ===== */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.25rem;
            margin-top: 1.25rem;
        }

        .template-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            gap: 0.9375rem;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .template-card h4 {
            color: var(--accent-primary);
            font-size: 1.1rem;
        }

        .template-card p {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            line-height: 1.5;
            flex-grow: 1;
        }

        /* ===== HISTORY SECTION (FIX 10) ===== */
        .history-section {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            margin-top: 2.5rem;
            padding: 1.5625rem;
            backdrop-filter: blur(10px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.9375rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h3 {
            color: var(--text-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.9375rem;
        }

        .history-empty {
            text-align: center;
            padding: 2.5rem 1.25rem;
            color: var(--text-tertiary);
        }

        .history-empty i {
            font-size: 3rem;
            margin-bottom: 0.9375rem;
            opacity: 0.5;
        }

        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-normal);
        }

        .history-item:hover {
            background: #475569;
            border-color: #64748b;
            transform: translateX(5px);
        }

        .history-item-content {
            flex-grow: 1;
            min-width: 0;
        }

        .history-input {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            gap: 1.25rem;
            color: var(--text-tertiary);
            font-size: 0.8125rem;
        }

        .history-style {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
            text-transform: capitalize;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .history-reuse-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .history-reuse-btn:hover {
            background: #0da271;
            transform: scale(1.1);
        }

        .history-delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .history-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* ===== GLOBAL PROCESSING INDICATOR (FIX 6) ===== */
        .global-processing {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem 3rem;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(10px);
        }

        .global-processing .spinner {
            width: 3rem;
            height: 3rem;
            border-width: 4px;
        }

        .global-processing span {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* ===== FOOTER ===== */
        .footer {
            margin-top: 3.125rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        #apiStatus {
            color: var(--success);
            font-weight: 600;
        }

        .footer-links {
            display: flex;
            gap: 1.25rem;
        }

        .footer-link {
            color: var(--text-tertiary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .footer-link:hover {
            color: var(--accent-primary);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .container {
                padding: 0.625rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1.25rem;
                text-align: center;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .style-buttons {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
                margin: 0.625rem;
            }
            
            .templates-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 0.9375rem;
                text-align: center;
            }
            
            .history-item {
                flex-direction: column;
                gap: 0.9375rem;
                align-items: stretch;
            }
            
            .history-item-actions {
                justify-content: flex-end;
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            z-index: 4000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-success {
            border-left: 4px solid var(--success);
        }

        .notification-error {
            border-left: 4px solid var(--danger);
        }

        .notification-warning {
            border-left: 4px solid var(--warning);
        }

        .notification-info {
            border-left: 4px solid var(--accent-primary);
        }

        .notification i {
            font-size: 1.25rem;
        }

        .notification-success i { color: var(--success); }
        .notification-error i { color: var(--danger); }
        .notification-warning i { color: var(--warning); }
        .notification-info i { color: var(--accent-primary); }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.25rem;
            margin-left: auto;
        }

        .notification-close:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body class="dark-theme">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1><i class="fas fa-robot"></i> PromptCraft Pro</h1>
                <p class="tagline">AI-Powered Prompt Engineering Studio</p>
            </div>
            <div class="header-controls">
                <button id="settingsBtn" class="btn btn-secondary">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button id="historyBtn" class="btn btn-secondary">
                    <i class="fas fa-history"></i> History
                </button>
                <button id="themeToggle" class="btn btn-secondary">
                    <i class="fas fa-moon"></i> Theme
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Step 1: Input -->
            <section class="step-section" id="step1">
                <div class="step-header">
                    <h2><span class="step-number">1</span> Describe Your Task</h2>
                    <div class="step-actions">
                        <button class="btn btn-small" id="maximizeStep1">
                            <i class="fas fa-expand"></i> Maximize
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <!-- FIX 2: Need Inspiration Button moved next to label -->
                    <div class="input-header">
                        <label for="userInput">
                            <strong>What would you like the AI to help you with?</strong>
                        </label>
                        <button class="btn btn-small btn-inspiration" id="inspirationBtn">
                            <i class="fas fa-lightbulb"></i> Need Inspiration?
                        </button>
                    </div>
                    <div class="textarea-container">
                        <textarea id="userInput" placeholder="Example: Create a marketing campaign for a new eco-friendly water bottle targeting millennials..." rows="6"></textarea>
                        <div class="textarea-actions">
                            <!-- FIX 3: Clear Text Button replaces Undo -->
                            <button class="btn btn-small btn-danger" id="clearStep1">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <div class="char-count">
                                <span id="charCount">0</span> / 3000 characters
                            </div>
                        </div>
                    </div>
                    <div class="style-selector">
                        <label>Prompt Style:</label>
                        <div class="style-buttons">
                            <button class="style-btn active" data-style="detailed">
                                <i class="fas fa-file-alt"></i> Detailed
                            </button>
                            <button class="style-btn" data-style="concise">
                                <i class="fas fa-bolt"></i> Concise
                            </button>
                            <button class="style-btn" data-style="creative">
                                <i class="fas fa-palette"></i> Creative
                            </button>
                            <button class="style-btn" data-style="professional">
                                <i class="fas fa-briefcase"></i> Professional
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2: Generated Prompt -->
            <section class="step-section" id="step2">
                <div class="step-header">
                    <h2><span class="step-number">2</span> Generated Prompt</h2>
                    <div class="step-actions">
                        <button class="btn btn-small" id="maximizeStep2">
                            <i class="fas fa-expand"></i> Maximize
                        </button>
                        <!-- FIX 5: Undo Button -->
                        <button class="btn btn-small" id="undoStep2" disabled style="opacity: 0.5;">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-container">
                        <div class="prompt-header">
                            <div class="model-indicator">
                                <i class="fas fa-microchip"></i>
                                <span id="modelName">Google Gemini 3 Flash Preview</span>
                            </div>
                            <div class="prompt-actions">
                                <button class="btn btn-small" id="copyPrompt">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-small" id="speakPrompt">
                                    <i class="fas fa-volume-up"></i> Speak
                                </button>
                            </div>
                        </div>
                        <div class="prompt-content" id="generatedPrompt">
                            <p class="placeholder-text">Your generated prompt will appear here after you click "Prepare Prompt"</p>
                        </div>
                        <div class="prompt-footer">
                            <div class="processing-indicator" id="processingIndicator" style="display: none;">
                                <div class="spinner"></div>
                                <span>Generating your prompt...</span>
                            </div>
                            <!-- FIX 7: Prepare Prompt → Reset Button -->
                            <button class="btn btn-primary btn-large" id="preparePromptBtn">
                                <i class="fas fa-magic"></i> Prepare Prompt
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="modal settings-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Settings & Preferences</h3>
                    <button class="btn-close" id="closeSettings">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <!-- Theme Settings -->
                    <div class="settings-section">
                        <!-- FIX 8: Settings Header Color -->
                        <h4 class="settings-header"><i class="fas fa-palette"></i> Theme</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="theme" value="dark" checked>
                                    <span class="setting-label">Dark Theme</span>
                                </label>
                                <p class="setting-description">Choose your preferred visual theme</p>
                            </div>
                        </div>
                    </div>

                    <!-- UI Density -->
                    <div class="settings-section">
                        <h4 class="settings-header"><i class="fas fa-layer-group"></i> UI Density</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="density" value="comfortable" checked>
                                    <span class="setting-label">Comfortable</span>
                                </label>
                                <p class="setting-description">Adjust spacing and density for optimal workflow</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Model Preferences -->
                    <div class="settings-section">
                        <h4 class="settings-header"><i class="fas fa-brain"></i> AI Model Preferences</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-3-flash-preview" checked>
                                    <span class="setting-label">Google Gemini 3 Flash Preview</span>
                                </label>
                                <p class="setting-description">Fastest Gemini model, best for creative tasks</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gpt-4o-mini">
                                    <span class="setting-label">OpenAI GPT-4o Mini</span>
                                </label>
                                <p class="setting-description">Cost-effective GPT model for general tasks</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="llama-3.1-8b-instant">
                                    <span class="setting-label">Meta Llama 3.1 8B (via Groq)</span>
                                </label>
                                <p class="setting-description">Fast open-source model from Meta</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-1.5-flash-latest">
                                    <span class="setting-label">Google Gemini 1.5 Flash Latest</span>
                                </label>
                                <p class="setting-description">Latest Gemini 1.5 version</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-1.5-flash">
                                    <span class="setting-label">Google Gemini 1.5 Flash</span>
                                </label>
                                <p class="setting-description">Legacy Gemini model</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelSettings">
                        Cancel
                    </button>
                    <!-- FIX 9: Save Settings Button -->
                    <button class="btn btn-primary" id="saveSettings" disabled>
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- FIX 1: Maximized View Modal -->
        <div class="modal-overlay" id="maximizedModal">
            <div class="modal maximized-modal">
                <div class="modal-header">
                    <h3 id="maximizedTitle">Maximized View</h3>
                    <button class="btn-close" id="closeMaximized">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content" id="maximizedContent">
                    <!-- Content will be dynamically populated -->
                </div>
                <div class="modal-footer" id="maximizedFooter">
                    <!-- Footer content will be dynamically populated -->
                </div>
            </div>
        </div>

        <!-- FIX 2: Inspiration/Templates Modal -->
        <div class="modal-overlay" id="inspirationModal">
            <div class="modal inspiration-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-lightbulb"></i> Inspiration & Templates</h3>
                    <button class="btn-close" id="closeInspiration">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="templates-grid">
                        <div class="template-card" data-template="marketing">
                            <h4>Marketing Campaign</h4>
                            <p>Create a marketing campaign for a new product...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="content">
                            <h4>Content Creation</h4>
                            <p>Write a blog post about a specific topic...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="code">
                            <h4>Code Generation</h4>
                            <p>Generate code for a specific functionality...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="creative">
                            <h4>Creative Writing</h4>
                            <p>Write a story or creative piece...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FIX 10: History Section -->
        <section class="history-section" id="historySection">
            <div class="section-header">
                <h3><i class="fas fa-history"></i> History</h3>
                <button class="btn btn-small" id="clearHistory">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            <div class="history-list" id="historyList">
                <div class="history-empty">
                    <i class="fas fa-clock"></i>
                    <p>No history yet. Your prompts will appear here.</p>
                </div>
            </div>
        </section>

        <!-- FIX 6: Global Processing Indicator -->
        <div class="global-processing" id="globalProcessingIndicator">
            <div class="spinner"></div>
            <span>Generating your prompt...</span>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>PromptCraft Pro v1.0 • Powered by AI • <span id="apiStatus">Connected</span></p>
                <div class="footer-links">
                    <a href="#" class="footer-link">Docs</a>
                    <a href="#" class="footer-link">Support</a>
                    <a href="#" class="footer-link">Privacy</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ===== STATE MANAGEMENT =====
            const state = {
                lastPromptState: null,
                history: JSON.parse(localStorage.getItem('promptcraft_history') || '[]'),
                settings: JSON.parse(localStorage.getItem('promptcraft_settings') || '{"theme":"dark","density":"comfortable","aiModel":"gemini-3-flash-preview"}'),
                settingsChanged: false
            };

            // ===== NOTIFICATION SYSTEM =====
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close"><i class="fas fa-times"></i></button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                
                // Manual close
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });
            }

            // ===== CHARACTER COUNT =====
            function updateCharCount() {
                const textarea = document.getElementById('userInput');
                const count = textarea.value.length;
                const charCount = document.getElementById('charCount');
                charCount.textContent = count;
                
                if (count > 3000) {
                    charCount.style.color = 'var(--danger)';
                } else if (count > 2500) {
                    charCount.style.color = 'var(--warning)';
                } else {
                    charCount.style.color = 'var(--text-tertiary)';
                }
            }

            document.getElementById('userInput').addEventListener('input', updateCharCount);

            // ===== FIX 1: MAXIMIZE BUTTON - FULL SCREEN MODAL =====
            document.getElementById('maximizeStep1').addEventListener('click', function() {
                const inputText = document.getElementById('userInput').value;
                const title = "Step 1: Describe Your Task";
                const content = `
                    <div class="maximized-input">
                        <label><strong>What would you like the AI to help you with?</strong></label>
                        <textarea class="maximized-textarea" rows="12" placeholder="Describe your task in detail...">${inputText}</textarea>
                    </div>
                `;
                const footer = `
                    <button class="btn btn-secondary" id="saveMaximizedInput">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                `;
                openMaximizedView(title, content, footer, 'step1');
            });

            document.getElementById('maximizeStep2').addEventListener('click', function() {
                const promptElement = document.getElementById('generatedPrompt');
                const promptContent = promptElement.innerHTML;
                const promptText = promptElement.textContent.trim();
                const title = "Step 2: Generated Prompt";
                const content = `
                    <div class="maximized-prompt">
                        <div class="prompt-header">
                            <div class="model-indicator">
                                <i class="fas fa-microchip"></i>
                                <span>${document.getElementById('modelName').textContent}</span>
                            </div>
                        </div>
                        <div class="maximized-prompt-content">
                            ${promptContent.includes('placeholder-text') ? 
                                '<p class="placeholder-text">No prompt generated yet.</p>' : 
                                promptContent}
                        </div>
                    </div>
                `;
                const footer = `
                    ${!promptContent.includes('placeholder-text') ? `
                        <button class="btn btn-secondary" id="undoMaximizedPrompt">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                    ` : ''}
                    ${promptText && !promptText.includes('Your generated prompt will appear here') ? `
                        <button class="btn btn-primary" id="copyMaximizedPrompt">
                            <i class="fas fa-copy"></i> Copy Prompt
                        </button>
                    ` : ''}
                `;
                openMaximizedView(title, content, footer, 'step2');
            });

            function openMaximizedView(title, content, footer, step) {
                document.getElementById('maximizedTitle').textContent = title;
                document.getElementById('maximizedContent').innerHTML = content;
                document.getElementById('maximizedFooter').innerHTML = footer;
                document.getElementById('maximizedModal').style.display = 'flex';
                document.body.classList.add('modal-open');
                
                // FIX 4: Hide Prepare Prompt button in maximized Step 2 view
                if (step === 'step2') {
                    document.getElementById('preparePromptBtn').style.visibility = 'hidden';
                }

                // Add event listeners for maximized view
                setTimeout(() => {
                    // FIX 5: Undo button in maximized view
                    const undoBtn = document.getElementById('undoMaximizedPrompt');
                    if (undoBtn) {
                        undoBtn.addEventListener('click', function() {
                            document.getElementById('undoStep2').click();
                            closeMaximizedView();
                        });
                    }

                    // Save button for input
                    const saveBtn = document.getElementById('saveMaximizedInput');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', function() {
                            const textarea = document.querySelector('.maximized-textarea');
                            if (textarea) {
                                document.getElementById('userInput').value = textarea.value;
                                updateCharCount();
                            }
                            closeMaximizedView();
                        });
                    }

                    // Copy button for output
                    const copyBtn = document.getElementById('copyMaximizedPrompt');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', function() {
                            const promptText = document.getElementById('generatedPrompt').textContent.trim();
                            if (promptText) {
                                navigator.clipboard.writeText(promptText).then(() => {
                                    showNotification('Prompt copied from maximized view!', 'success');
                                });
                            }
                        });
                    }

                    // Focus on textarea for input view
                    if (step === 'step1') {
                        const textarea = document.querySelector('.maximized-textarea');
                        if (textarea) {
                            textarea.focus();
                            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                        }
                    }
                }, 10);
            }

            function closeMaximizedView() {
                document.getElementById('maximizedModal').style.display = 'none';
                document.body.classList.remove('modal-open');
                document.getElementById('preparePromptBtn').style.visibility = 'visible';
            }

            document.getElementById('closeMaximized').addEventListener('click', closeMaximizedView);

            // ===== FIX 2: NEED INSPIRATION BUTTON =====
            document.getElementById('inspirationBtn').addEventListener('click', function() {
                document.getElementById('inspirationModal').style.display = 'flex';
                document.body.classList.add('modal-open');
            });

            document.getElementById('closeInspiration').addEventListener('click', function() {
                document.getElementById('inspirationModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            });

            // Template selection
            document.querySelectorAll('.use-template').forEach(button => {
                button.addEventListener('click', function() {
                    const templateCard = this.closest('.template-card');
                    const templateType = templateCard.dataset.template;
                    const templates = {
                        marketing: "Create a marketing campaign for a new eco-friendly product targeting millennials. Include social media strategy, influencer partnerships, and key messaging.",
                        content: "Write a comprehensive blog post about the benefits of meditation for mental health. Include scientific references, practical tips, and personal anecdotes.",
                        code: "Generate a Python function that takes a list of numbers and returns statistics including mean, median, mode, and standard deviation.",
                        creative: "Write a short story about a character who discovers they can communicate with animals. Include dialogue, character development, and a moral lesson."
                    };
                    
                    document.getElementById('userInput').value = templates[templateType] || '';
                    updateCharCount();
                    document.getElementById('inspirationModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Auto-scroll to textarea
                    document.getElementById('userInput').focus();
                    document.getElementById('userInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    showNotification('Template loaded successfully!', 'success');
                });
            });

            // ===== FIX 3: CLEAR TEXT BUTTON =====
            document.getElementById('clearStep1').addEventListener('click', function() {
                document.getElementById('userInput').value = '';
                document.getElementById('generatedPrompt').innerHTML = 
                    '<p class="placeholder-text">Your generated prompt will appear here after you click "Prepare Prompt"</p>';
                
                // FIX 7: Reset Prepare Prompt button
                const prepareBtn = document.getElementById('preparePromptBtn');
                prepareBtn.innerHTML = '<i class="fas fa-magic"></i> Prepare Prompt';
                prepareBtn.classList.remove('btn-reset');
                prepareBtn.onclick = preparePrompt;
                
                updateCharCount();
                
                // Reset style buttons
                document.querySelectorAll('.style-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.style-btn[data-style="detailed"]').classList.add('active');
                
                // Reset undo button
                document.getElementById('undoStep2').disabled = true;
                document.getElementById('undoStep2').style.opacity = '0.5';
                
                showNotification('Application cleared', 'success');
            });

            // ===== FIX 5: UNDO BUTTON FUNCTIONALITY =====
            document.getElementById('undoStep2').addEventListener('click', function() {
                if (state.lastPromptState) {
                    document.getElementById('generatedPrompt').innerHTML = state.lastPromptState;
                    state.lastPromptState = null;
                    this.disabled = true;
                    this.style.opacity = '0.5';
                    showNotification('Undo completed', 'info');
                }
            });

            // ===== FIX 6: PROCESSING LOADER =====
            function showGlobalProcessing(show, message = 'Generating your prompt...') {
                const indicator = document.getElementById('globalProcessingIndicator');
                if (indicator) {
                    if (show) {
                        indicator.querySelector('span').textContent = message;
                        indicator.style.display = 'flex';
                    } else {
                        indicator.style.display = 'none';
                    }
                }
            }

            // ===== FIX 7: PREPARE PROMPT → RESET BUTTON BEHAVIOR =====
            async function preparePrompt() {
                const inputText = document.getElementById('userInput').value.trim();
                if (!inputText) {
                    showNotification('Please enter some text in Step 1 first.', 'error');
                    return;
                }

                // Save state for undo
                state.lastPromptState = document.getElementById('generatedPrompt').innerHTML;
                document.getElementById('undoStep2').disabled = false;
                document.getElementById('undoStep2').style.opacity = '1';

                // Show processing indicators
                showGlobalProcessing(true, 'Crafting your perfect prompt...');
                const localIndicator = document.getElementById('processingIndicator');
                localIndicator.style.display = 'flex';
                
                const prepareBtn = document.getElementById('preparePromptBtn');
                const originalBtnHTML = prepareBtn.innerHTML;
                prepareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                prepareBtn.disabled = true;

                try {
                    // Get selected style
                    const selectedStyle = document.querySelector('.style-btn.active').dataset.style;
                    
                    // Get selected model from settings
                    const selectedModel = state.settings.aiModel || 'gemini-3-flash-preview';
                    const modelDisplayNames = {
                        'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                        'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                        'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                        'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                        'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                    };
                    
                    document.getElementById('modelName').textContent = modelDisplayNames[selectedModel] || 'Google Gemini 3 Flash Preview';
                    
                    // Simulate API call with loading
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Generate mock prompt
                    const mockPrompt = generateMockPrompt(inputText, selectedStyle);
                    
                    // Display the generated prompt
                    document.getElementById('generatedPrompt').innerHTML = `
                        <div class="prompt-result">
                            <h4><i class="fas fa-check-circle"></i> Generated Prompt:</h4>
                            <div class="prompt-text">${mockPrompt}</div>
                            <div class="prompt-meta">
                                <span class="meta-item"><i class="fas fa-clock"></i> ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                <span class="meta-item"><i class="fas fa-palette"></i> ${selectedStyle.charAt(0).toUpperCase() + selectedStyle.slice(1)}</span>
                            </div>
                        </div>
                    `;
                    
                    // FIX 7: Change button to Reset
                    prepareBtn.innerHTML = '<i class="fas fa-redo"></i> Reset';
                    prepareBtn.classList.add('btn-reset');
                    prepareBtn.onclick = resetApplication;
                    prepareBtn.disabled = false;
                    
                    // Add to history
                    addToHistory(inputText, mockPrompt, selectedStyle);
                    
                    showNotification('Prompt successfully generated!', 'success');
                    
                } catch (error) {
                    console.error('Error generating prompt:', error);
                    document.getElementById('generatedPrompt').innerHTML = `
                        <div class="prompt-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h4>Error Generating Prompt</h4>
                            <p>There was an issue generating your prompt. Please try again.</p>
                        </div>
                    `;
                    prepareBtn.innerHTML = originalBtnHTML;
                    prepareBtn.disabled = false;
                    showNotification('Failed to generate prompt. Please try again.', 'error');
                } finally {
                    // Hide processing indicators
                    showGlobalProcessing(false);
                    localIndicator.style.display = 'none';
                }
            }

            function resetApplication() {
                document.getElementById('clearStep1').click();
                showNotification('Application reset', 'success');
            }

            document.getElementById('preparePromptBtn').addEventListener('click', preparePrompt);

            // ===== FIX 8 & 9: SETTINGS MANAGEMENT =====
            // Load saved settings
            if (state.settings.theme) {
                document.body.className = state.settings.theme + '-theme';
            }
            if (state.settings.aiModel) {
                const modelDisplayNames = {
                    'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                    'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                    'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                    'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                    'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                };
                document.getElementById('modelName').textContent = modelDisplayNames[state.settings.aiModel] || 'Google Gemini 3 Flash Preview';
            }

            // Settings modal controls
            document.getElementById('settingsBtn').addEventListener('click', function() {
                // Reset settings changed state
                state.settingsChanged = false;
                document.getElementById('saveSettings').disabled = true;
                
                // Load saved settings into form
                document.querySelector(`input[name="theme"][value="${state.settings.theme || 'dark'}"]`).checked = true;
                document.querySelector(`input[name="density"][value="${state.settings.density || 'comfortable'}"]`).checked = true;
                document.querySelector(`input[name="aiModel"][value="${state.settings.aiModel || 'gemini-3-flash-preview'}"]`).checked = true;
                
                document.getElementById('settingsModal').style.display = 'flex';
                document.body.classList.add('modal-open');
            });

            document.getElementById('closeSettings').addEventListener('click', function() {
                document.getElementById('settingsModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            });

            document.getElementById('cancelSettings').addEventListener('click', function() {
                document.getElementById('closeSettings').click();
            });

            // Track settings changes
            document.querySelectorAll('#settingsModal input').forEach(input => {
                input.addEventListener('change', function() {
                    state.settingsChanged = true;
                    document.getElementById('saveSettings').disabled = false;
                });
            });

            // FIX 9: Save Settings Button
            document.getElementById('saveSettings').addEventListener('click', function() {
                if (!state.settingsChanged) return;
                
                // Get selected settings
                state.settings.theme = document.querySelector('input[name="theme"]:checked').value;
                state.settings.density = document.querySelector('input[name="density"]:checked').value;
                state.settings.aiModel = document.querySelector('input[name="aiModel"]:checked').value;
                
                // Save to localStorage
                localStorage.setItem('promptcraft_settings', JSON.stringify(state.settings));
                
                // Apply settings
                document.body.className = state.settings.theme + '-theme';
                
                // Update model indicator
                const modelDisplayNames = {
                    'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                    'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                    'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                    'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                    'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                };
                document.getElementById('modelName').textContent = modelDisplayNames[state.settings.aiModel] || 'Google Gemini 3 Flash Preview';
                
                // Reset state
                state.settingsChanged = false;
                this.disabled = true;
                
                // Close modal
                document.getElementById('closeSettings').click();
                
                showNotification('Settings saved successfully!', 'success');
            });

            // ===== FIX 10: HISTORY NAVIGATION & REUSABILITY =====
            document.getElementById('historyBtn').addEventListener('click', function() {
                document.getElementById('historySection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                loadHistory();
            });

            function loadHistory() {
                const historyList = document.getElementById('historyList');
                
                if (state.history.length === 0) {
                    historyList.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-clock"></i>
                            <p>No history yet. Your prompts will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                historyList.innerHTML = '';
                state.history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-item-content">
                            <div class="history-input">
                                <strong>Input:</strong> ${item.input.substring(0, 100)}${item.input.length > 100 ? '...' : ''}
                            </div>
                            <div class="history-meta">
                                <span class="history-style">${item.style}</span>
                                <span class="history-time">${item.time}</span>
                            </div>
                        </div>
                        <div class="history-item-actions">
                            <button class="history-reuse-btn" title="Reuse this prompt">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="history-delete-btn" title="Delete from history">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add reuse functionality
                    const reuseBtn = historyItem.querySelector('.history-reuse-btn');
                    reuseBtn.addEventListener('click', function() {
                        document.getElementById('userInput').value = item.input;
                        updateCharCount();
                        
                        // Display the prompt
                        document.getElementById('generatedPrompt').innerHTML = `
                            <div class="prompt-result">
                                <h4><i class="fas fa-history"></i> Prompt from History:</h4>
                                <div class="prompt-text">${item.prompt}</div>
                                <div class="prompt-meta">
                                    <span class="meta-item"><i class="fas fa-clock"></i> ${item.time}</span>
                                    <span class="meta-item"><i class="fas fa-palette"></i> ${item.style.charAt(0).toUpperCase() + item.style.slice(1)}</span>
                                </div>
                            </div>
                        `;
                        
                        // Update Prepare Prompt button to Reset
                        const prepareBtn = document.getElementById('preparePromptBtn');
                        prepareBtn.innerHTML = '<i class="fas fa-redo"></i> Reset';
                        prepareBtn.classList.add('btn-reset');
                        prepareBtn.onclick = resetApplication;
                        
                        // Scroll to Step 1
                        document.getElementById('step1').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        
                        // Focus on textarea
                        document.getElementById('userInput').focus();
                        
                        showNotification('Prompt loaded from history', 'success');
                    });
                    
                    // Add delete functionality
                    const deleteBtn = historyItem.querySelector('.history-delete-btn');
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Delete this history item?')) {
                            state.history.splice(index, 1);
                            localStorage.setItem('promptcraft_history', JSON.stringify(state.history));
                            loadHistory();
                            showNotification('History item deleted', 'success');
                        }
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }

            function addToHistory(inputText, generatedPrompt, style) {
                const historyItem = {
                    input: inputText,
                    prompt: generatedPrompt,
                    style: style,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                state.history.unshift(historyItem);
                if (state.history.length > 50) {
                    state.history = state.history.slice(0, 50);
                }
                
                localStorage.setItem('promptcraft_history', JSON.stringify(state.history));
                loadHistory();
            }

            // Clear history button
            document.getElementById('clearHistory').addEventListener('click', function() {
                if (state.history.length === 0) return;
                
                if (confirm('Are you sure you want to clear all history?')) {
                    state.history = [];
                    localStorage.setItem('promptcraft_history', JSON.stringify([]));
                    loadHistory();
                    showNotification('History cleared', 'success');
                }
            });

            // ===== STYLE BUTTONS =====
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // ===== COPY PROMPT BUTTON =====
            document.getElementById('copyPrompt').addEventListener('click', function() {
                const promptText = document.querySelector('.prompt-text')?.textContent || 
                                 document.getElementById('generatedPrompt').textContent;
                
                if (promptText && !promptText.includes('Your generated prompt will appear here')) {
                    navigator.clipboard.writeText(promptText).then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                        showNotification('Prompt copied to clipboard!', 'success');
                    });
                }
            });

            // ===== SPEAK PROMPT BUTTON =====
            document.getElementById('speakPrompt').addEventListener('click', function() {
                const promptText = document.querySelector('.prompt-text')?.textContent || 
                                 document.getElementById('generatedPrompt').textContent;
                
                if (promptText && !promptText.includes('Your generated prompt will appear here')) {
                    if ('speechSynthesis' in window) {
                        const speech = new SpeechSynthesisUtterance(promptText);
                        speech.lang = 'en-US';
                        speech.rate = 0.9;
                        window.speechSynthesis.speak(speech);
                        showNotification('Reading prompt aloud...', 'info');
                    } else {
                        showNotification('Text-to-speech not supported in your browser', 'warning');
                    }
                }
            });

            // ===== THEME TOGGLE =====
            document.getElementById('themeToggle').addEventListener('click', function() {
                const isDark = document.body.classList.contains('dark-theme');
                if (isDark) {
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('light-theme');
                    this.innerHTML = '<i class="fas fa-sun"></i> Theme';
                } else {
                    document.body.classList.remove('light-theme');
                    document.body.classList.add('dark-theme');
                    this.innerHTML = '<i class="fas fa-moon"></i> Theme';
                }
                
                // Save theme preference
                state.settings.theme = isDark ? 'light' : 'dark';
                localStorage.setItem('promptcraft_settings', JSON.stringify(state.settings));
            });

            // ===== HELPER FUNCTIONS =====
            function generateMockPrompt(input, style) {
                const styles = {
                    detailed: `You are an expert AI assistant. Based on the user request: "${input}"

Please create a comprehensive and detailed response that includes:

1. **Role Definition**: Specify the exact role you should embody
2. **Core Objective**: Clearly state the main goal
3. **Key Components**: Break down into essential elements
4. **Step-by-Step Process**: Provide actionable steps
5. **Best Practices**: Include industry standards and tips
6. **Expected Output**: Describe the final deliverable
7. **Quality Criteria**: List success metrics and evaluation criteria

Format the response in a structured, professional manner with clear headings and bullet points where appropriate.`,
                    
                    concise: `Task: ${input}

Provide a direct, focused response with clear, actionable instructions. Keep it brief but comprehensive.`,
                    
                    creative: `Creative Request: ${input}

Approach this with imagination and innovation. Use engaging language, incorporate storytelling elements, and focus on unique perspectives. Be inspiring and original in your response structure.`,
                    
                    professional: `Professional Assignment: ${input}

Prepare a formal, business-appropriate response structured as:

• Executive Summary
• Background Context
• Strategic Analysis
• Implementation Plan
• Risk Assessment
• Next Steps
• Success Metrics

Use professional tone and corporate formatting.`
                };
                
                return styles[style] || styles.detailed;
            }

            // ===== INITIALIZE =====
            updateCharCount();
            loadHistory();

            // Close modals with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal-overlay[style*="display: flex"]');
                    if (openModals.length > 0) {
                        Array.from(openModals).pop().style.display = 'none';
                        document.body.classList.remove('modal-open');
                    }
                }
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    }
                });
            });
        });
    </script>

    <!-- Light Theme Styles -->
    <style>
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .light-theme body {
            background-image: 
                radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(241, 245, 249, 0.3) 0px, transparent 50%);
        }
    </style>
</body>
</html>
