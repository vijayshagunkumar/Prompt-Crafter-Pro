<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptCraft Pro - AI Prompt Engineering Tool</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/ui-components.css">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dark-theme">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1><i class="fas fa-robot"></i> PromptCraft Pro</h1>
                <p class="tagline">AI-Powered Prompt Engineering Studio</p>
            </div>
            <div class="header-controls">
                <button id="settingsBtn" class="btn btn-secondary">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button id="historyBtn" class="btn btn-secondary">
                    <i class="fas fa-history"></i> History
                </button>
                <button id="themeToggle" class="btn btn-secondary">
                    <i class="fas fa-moon"></i> Theme
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Step 1: Input -->
            <section class="step-section" id="step1">
                <div class="step-header">
                    <h2><span class="step-number">1</span> Describe Your Task</h2>
                    <div class="step-actions">
                        <button class="btn btn-small" id="maximizeStep1">
                            <i class="fas fa-expand"></i> Maximize
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="input-header-container">
                        <label for="userInput">
                            <strong>What would you like the AI to help you with?</strong>
                        </label>
                        <button class="btn btn-small btn-inspiration" id="inspirationBtn">
                            <i class="fas fa-lightbulb"></i> Need Inspiration?
                        </button>
                    </div>
                    <div class="textarea-container">
                        <textarea id="userInput" placeholder="Example: Create a marketing campaign for a new eco-friendly water bottle targeting millennials..." rows="6"></textarea>
                        <div class="textarea-actions">
                            <button class="btn btn-small btn-clear" id="clearStep1">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <div class="char-count">
                                <span id="charCount">0</span> / 3000 characters
                            </div>
                        </div>
                    </div>
                    <div class="style-selector">
                        <label>Prompt Style:</label>
                        <div class="style-buttons">
                            <button class="style-btn active" data-style="detailed">
                                <i class="fas fa-file-alt"></i> Detailed
                            </button>
                            <button class="style-btn" data-style="concise">
                                <i class="fas fa-bolt"></i> Concise
                            </button>
                            <button class="style-btn" data-style="creative">
                                <i class="fas fa-palette"></i> Creative
                            </button>
                            <button class="style-btn" data-style="professional">
                                <i class="fas fa-briefcase"></i> Professional
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2: Generated Prompt -->
            <section class="step-section" id="step2">
                <div class="step-header">
                    <h2><span class="step-number">2</span> Generated Prompt</h2>
                    <div class="step-actions">
                        <button class="btn btn-small" id="maximizeStep2">
                            <i class="fas fa-expand"></i> Maximize
                        </button>
                        <button class="btn btn-small" id="undoStep2">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-container">
                        <div class="prompt-header">
                            <div class="model-indicator">
                                <i class="fas fa-microchip"></i>
                                <span id="modelName">Google Gemini 3 Flash Preview</span>
                            </div>
                            <div class="prompt-actions">
                                <button class="btn btn-small" id="copyPrompt">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-small" id="speakPrompt">
                                    <i class="fas fa-volume-up"></i> Speak
                                </button>
                            </div>
                        </div>
                        <div class="prompt-content" id="generatedPrompt">
                            <p class="placeholder-text">Your generated prompt will appear here after you click "Prepare Prompt"</p>
                        </div>
                        <div class="prompt-footer">
                            <div class="processing-indicator" id="processingIndicator" style="display: none;">
                                <div class="spinner"></div>
                                <span>Generating your prompt...</span>
                            </div>
                            <button class="btn btn-primary btn-large" id="preparePromptBtn">
                                <i class="fas fa-magic"></i> Prepare Prompt
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal" style="display: none;">
            <div class="modal settings-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Settings & Preferences</h3>
                    <button class="btn-close" id="closeSettings">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <!-- Theme Settings -->
                    <div class="settings-section">
                        <h4 class="settings-section-header"><i class="fas fa-palette"></i> Theme</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="theme" value="dark" checked>
                                    <span class="setting-label">Dark Theme</span>
                                </label>
                                <p class="setting-description">Choose your preferred visual theme</p>
                            </div>
                        </div>
                    </div>

                    <!-- UI Density -->
                    <div class="settings-section">
                        <h4 class="settings-section-header"><i class="fas fa-layer-group"></i> UI Density</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="density" value="comfortable" checked>
                                    <span class="setting-label">Comfortable</span>
                                </label>
                                <p class="setting-description">Adjust spacing and density for optimal workflow</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Model Preferences -->
                    <div class="settings-section">
                        <h4 class="settings-section-header"><i class="fas fa-brain"></i> AI Model Preferences</h4>
                        <div class="settings-group">
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-3-flash-preview" checked>
                                    <span class="setting-label">Google Gemini 3 Flash Preview</span>
                                </label>
                                <p class="setting-description">Fastest Gemini model, best for creative tasks</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gpt-4o-mini">
                                    <span class="setting-label">OpenAI GPT-4o Mini</span>
                                </label>
                                <p class="setting-description">Cost-effective GPT model for general tasks</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="llama-3.1-8b-instant">
                                    <span class="setting-label">Meta Llama 3.1 8B (via Groq)</span>
                                </label>
                                <p class="setting-description">Fast open-source model from Meta</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-1.5-flash-latest">
                                    <span class="setting-label">Google Gemini 1.5 Flash Latest</span>
                                </label>
                                <p class="setting-description">Latest Gemini 1.5 version</p>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="radio" name="aiModel" value="gemini-1.5-flash">
                                    <span class="setting-label">Google Gemini 1.5 Flash</span>
                                </label>
                                <p class="setting-description">Legacy Gemini model</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelSettings">
                        Cancel
                    </button>
                    <button class="btn btn-primary" id="saveSettings" disabled>
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Maximized View Modal (FIX 1, 4, 5) -->
        <div class="maximize-modal" id="maximizeModal" style="display: none;">
            <div class="maximize-modal-content">
                <div class="maximize-modal-header">
                    <h3 id="maximizedTitle"></h3>
                    <button class="btn-close" id="closeMaximizeBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="maximize-modal-body" id="maximizeContent">
                    <!-- Content will be dynamically populated -->
                </div>
                <div class="maximize-modal-footer" id="maximizeFooter">
                    <!-- Footer content will be dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Inspiration/Templates Modal -->
        <div class="modal-overlay" id="inspirationModal" style="display: none;">
            <div class="modal inspiration-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-lightbulb"></i> Inspiration & Templates</h3>
                    <button class="btn-close" id="closeInspiration">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="templates-grid">
                        <div class="template-card" data-template="marketing">
                            <h4>Marketing Campaign</h4>
                            <p>Create a marketing campaign for a new product...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="content">
                            <h4>Content Creation</h4>
                            <p>Write a blog post about a specific topic...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="code">
                            <h4>Code Generation</h4>
                            <p>Generate code for a specific functionality...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                        <div class="template-card" data-template="creative">
                            <h4>Creative Writing</h4>
                            <p>Write a story or creative piece...</p>
                            <button class="btn btn-small use-template">Use</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (FIX 10) -->
        <section class="history-section" id="historySection">
            <div class="section-header">
                <h3><i class="fas fa-history"></i> History</h3>
                <button class="btn btn-small" id="clearHistory">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            <div class="history-list" id="historyList">
                <!-- History items will be dynamically added here -->
                <div class="history-empty">
                    <i class="fas fa-clock"></i>
                    <p>No history yet. Your prompts will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Global Processing Indicator (FIX 6) -->
        <div class="processing-indicator" id="globalProcessingIndicator" style="display: none;">
            <div class="spinner"></div>
            <span id="globalProcessingText">Generating prompt...</span>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>PromptCraft Pro v1.0 • Powered by AI • <span id="apiStatus">Connected</span></p>
                <div class="footer-links">
                    <a href="#" class="footer-link">Docs</a>
                    <a href="#" class="footer-link">Support</a>
                    <a href="#" class="footer-link">Privacy</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="js/loader.js"></script>
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/debounce.js"></script>
    <script src="js/services/storage-service.js"></script>
    <script src="js/services/settings-service.js"></script>
    <script src="js/services/notification-service.js"></script>
    <script src="js/services/api-service.js"></script>
    <script src="js/modules/intent-detector.js"></script>
    <script src="js/modules/prompt-generator.js"></script>
    <script src="js/modules/ai-ranker.js"></script>
    <script src="js/modules/voice-manager.js"></script>
    <script src="js/modules/template-manager.js"></script>
    <script src="js/modules/history-manager.js"></script>
    <script src="js/modules/theme-manager.js"></script>
    <script src="js/core/events.js"></script>
    <script src="js/core/state.js"></script>
    <script src="js/core/app.js"></script>
    
    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            const app = new PromptCraftApp();
            
            // FIX 1: Maximize Button - Full Screen Modal
            document.getElementById('maximizeStep1').addEventListener('click', function() {
                const inputText = document.getElementById('userInput').value;
                const title = "Step 1: Describe Your Task";
                const content = `
                    <div class="maximized-input-container">
                        <div class="maximized-input-header">
                            <h4>What would you like the AI to help you with?</h4>
                            <button class="btn btn-small btn-inspiration" id="maximizedInspirationBtn">
                                <i class="fas fa-lightbulb"></i> Need Inspiration?
                            </button>
                        </div>
                        <textarea class="maximized-textarea" rows="15" placeholder="Describe your task in detail...">${inputText}</textarea>
                    </div>
                `;
                const footer = `
                    <button class="btn btn-secondary" id="saveMaximizedInput">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                `;
                openMaximizedView(title, content, footer);
            });
            
            document.getElementById('maximizeStep2').addEventListener('click', function() {
                const promptText = document.getElementById('generatedPrompt').textContent.trim();
                const title = "Step 2: Generated Prompt";
                const modelName = document.getElementById('modelName').textContent;
                const content = `
                    <div class="maximized-prompt-container">
                        <div class="maximized-prompt-header">
                            <div class="model-indicator">
                                <i class="fas fa-microchip"></i>
                                <span>${modelName}</span>
                            </div>
                        </div>
                        <div class="maximized-prompt-content">
                            ${promptText ? `<pre>${escapeHtml(promptText)}</pre>` : '<p class="placeholder-text">No prompt generated yet.</p>'}
                        </div>
                    </div>
                `;
                const footer = `
                    <button class="btn btn-secondary" id="maximizeUndoBtn">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button class="btn btn-primary" id="copyMaximizedPrompt">
                        <i class="fas fa-copy"></i> Copy Prompt
                    </button>
                `;
                openMaximizedView(title, content, footer);
            });
            
            function openMaximizedView(title, content, footer = '') {
                document.getElementById('maximizedTitle').textContent = title;
                document.getElementById('maximizeContent').innerHTML = content;
                document.getElementById('maximizeFooter').innerHTML = footer;
                document.getElementById('maximizeModal').style.display = 'flex';
                document.body.classList.add('modal-open');
                
                // Add event listeners for maximized view buttons
                setTimeout(() => {
                    // FIX 5: Undo button in maximized view
                    const undoBtn = document.getElementById('maximizeUndoBtn');
                    if (undoBtn) {
                        undoBtn.addEventListener('click', function() {
                            document.getElementById('undoStep2').click();
                            closeMaximizedView();
                        });
                    }
                    
                    // Save button for input
                    const saveBtn = document.getElementById('saveMaximizedInput');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', function() {
                            const textarea = document.querySelector('.maximized-textarea');
                            if (textarea && document.getElementById('userInput')) {
                                document.getElementById('userInput').value = textarea.value;
                                updateCharCount();
                            }
                            closeMaximizedView();
                        });
                    }
                    
                    // Copy button for output
                    const copyBtn = document.getElementById('copyMaximizedPrompt');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', function() {
                            const promptText = document.getElementById('generatedPrompt').textContent.trim();
                            if (promptText) {
                                navigator.clipboard.writeText(promptText);
                                showNotification('Prompt copied from maximized view!', 'success');
                            }
                        });
                    }
                    
                    // Inspiration button in maximized view
                    const inspirationBtn = document.getElementById('maximizedInspirationBtn');
                    if (inspirationBtn) {
                        inspirationBtn.addEventListener('click', function() {
                            document.getElementById('inspirationModal').style.display = 'block';
                            document.body.classList.add('modal-open');
                        });
                    }
                    
                    // Focus on textarea for input view
                    if (title.includes('Step 1')) {
                        const textarea = document.querySelector('.maximized-textarea');
                        if (textarea) {
                            textarea.focus();
                        }
                    }
                }, 10);
            }
            
            function closeMaximizedView() {
                document.getElementById('maximizeModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            }
            
            document.getElementById('closeMaximizeBtn').addEventListener('click', closeMaximizedView);
            
            // FIX 2: Need Inspiration Button
            document.getElementById('inspirationBtn').addEventListener('click', function() {
                document.getElementById('inspirationModal').style.display = 'block';
                document.body.classList.add('modal-open');
            });
            
            document.getElementById('closeInspiration').addEventListener('click', function() {
                document.getElementById('inspirationModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            
            // Template selection
            document.querySelectorAll('.use-template').forEach(button => {
                button.addEventListener('click', function() {
                    const templateCard = this.closest('.template-card');
                    const templateType = templateCard.dataset.template;
                    const templates = {
                        marketing: "Create a marketing campaign for a new eco-friendly product targeting millennials. Include social media strategy, influencer partnerships, and key messaging.",
                        content: "Write a comprehensive blog post about the benefits of meditation for mental health. Include scientific references, practical tips, and personal anecdotes.",
                        code: "Generate a Python function that takes a list of numbers and returns statistics including mean, median, mode, and standard deviation.",
                        creative: "Write a short story about a character who discovers they can communicate with animals. Include dialogue, character development, and a moral lesson."
                    };
                    
                    document.getElementById('userInput').value = templates[templateType] || '';
                    updateCharCount();
                    document.getElementById('inspirationModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Auto-scroll to textarea
                    document.getElementById('userInput').focus();
                    document.getElementById('userInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    showNotification('Template loaded!', 'success');
                });
            });
            
            // FIX 3: Clear Text Button
            document.getElementById('clearStep1').addEventListener('click', function() {
                document.getElementById('userInput').value = '';
                document.getElementById('generatedPrompt').innerHTML = 
                    '<p class="placeholder-text">Your generated prompt will appear here after you click "Prepare Prompt"</p>';
                document.getElementById('preparePromptBtn').innerHTML = 
                    '<i class="fas fa-magic"></i> Prepare Prompt';
                document.getElementById('preparePromptBtn').classList.remove('btn-reset');
                document.getElementById('preparePromptBtn').onclick = preparePrompt;
                updateCharCount();
                
                // Reset style buttons
                document.querySelectorAll('.style-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.style-btn[data-style="detailed"]').classList.add('active');
                
                // Reset progress
                const progressFill = document.querySelector('.progress-bar');
                if (progressFill) {
                    progressFill.style.width = '33%';
                }
                
                showNotification('Application cleared', 'success');
            });
            
            // Character count
            function updateCharCount() {
                const textarea = document.getElementById('userInput');
                const count = textarea.value.length;
                document.getElementById('charCount').textContent = count;
                
                if (count > 3000) {
                    document.getElementById('charCount').style.color = 'var(--danger-color)';
                } else if (count > 2500) {
                    document.getElementById('charCount').style.color = 'var(--warning-color)';
                } else {
                    document.getElementById('charCount').style.color = '';
                }
            }
            
            document.getElementById('userInput').addEventListener('input', updateCharCount);
            
            // FIX 5: Undo button functionality
            let lastPromptState = '';
            document.getElementById('undoStep2').addEventListener('click', function() {
                if (lastPromptState) {
                    document.getElementById('generatedPrompt').innerHTML = lastPromptState;
                    lastPromptState = '';
                    this.style.opacity = '0.5';
                    this.disabled = true;
                    showNotification('Undo completed', 'info');
                }
            });
            
            // FIX 6: Processing Loader
            function showProcessing(show, message = 'Generating prompt...') {
                const indicator = document.getElementById('globalProcessingIndicator');
                const text = document.getElementById('globalProcessingText');
                
                if (indicator && text) {
                    if (show) {
                        text.textContent = message;
                        indicator.style.display = 'flex';
                    } else {
                        indicator.style.display = 'none';
                    }
                }
            }
            
            // FIX 7: Prepare Prompt → Reset Button Behavior
            async function preparePrompt() {
                const inputText = document.getElementById('userInput').value.trim();
                if (!inputText) {
                    showNotification('Please enter some text in Step 1 first.', 'error');
                    return;
                }
                
                // Save state for undo
                lastPromptState = document.getElementById('generatedPrompt').innerHTML;
                document.getElementById('undoStep2').style.opacity = '1';
                document.getElementById('undoStep2').disabled = false;
                
                // Show processing indicator
                showProcessing(true, 'Crafting your perfect prompt...');
                const prepareBtn = document.getElementById('preparePromptBtn');
                const originalBtnHTML = prepareBtn.innerHTML;
                prepareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                prepareBtn.disabled = true;
                
                try {
                    // Get selected style
                    const selectedStyle = document.querySelector('.style-btn.active').dataset.style;
                    
                    // Get selected model from settings
                    const selectedModel = document.querySelector('input[name="aiModel"]:checked').value;
                    const modelDisplayNames = {
                        'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                        'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                        'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                        'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                        'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                    };
                    
                    document.getElementById('modelName').textContent = modelDisplayNames[selectedModel] || 'Google Gemini 3 Flash Preview';
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Generate mock prompt
                    const mockPrompt = generateMockPrompt(inputText, selectedStyle);
                    
                    // Display the generated prompt
                    document.getElementById('generatedPrompt').innerHTML = `
                        <div class="prompt-result">
                            <h4>Generated Prompt:</h4>
                            <div class="prompt-text">${mockPrompt}</div>
                            <div class="prompt-meta">
                                <span class="meta-item"><i class="fas fa-clock"></i> ${new Date().toLocaleTimeString()}</span>
                                <span class="meta-item"><i class="fas fa-style"></i> ${selectedStyle.charAt(0).toUpperCase() + selectedStyle.slice(1)}</span>
                            </div>
                        </div>
                    `;
                    
                    // FIX 7: Change button to Reset
                    prepareBtn.innerHTML = '<i class="fas fa-redo"></i> Reset';
                    prepareBtn.classList.add('btn-reset');
                    prepareBtn.onclick = resetApplication;
                    prepareBtn.disabled = false;
                    
                    // Update progress
                    const progressFill = document.querySelector('.progress-bar');
                    if (progressFill) {
                        progressFill.style.width = '66%';
                    }
                    
                    // Add to history
                    addToHistory(inputText, mockPrompt, selectedStyle);
                    
                    showNotification('Prompt successfully generated!', 'success');
                    
                } catch (error) {
                    console.error('Error generating prompt:', error);
                    document.getElementById('generatedPrompt').innerHTML = `
                        <div class="prompt-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h4>Error Generating Prompt</h4>
                            <p>There was an issue generating your prompt. Please try again.</p>
                        </div>
                    `;
                    prepareBtn.innerHTML = originalBtnHTML;
                    prepareBtn.disabled = false;
                    showNotification('Failed to generate prompt. Please try again.', 'error');
                } finally {
                    showProcessing(false);
                }
            }
            
            function resetApplication() {
                document.getElementById('clearStep1').click();
                showNotification('Application reset', 'success');
            }
            
            document.getElementById('preparePromptBtn').addEventListener('click', preparePrompt);
            
            // FIX 9: Save Settings Button
            let settingsChanged = false;
            const settingsInputs = document.querySelectorAll('#settingsModal input, #settingsModal select');
            const saveSettingsBtn = document.getElementById('saveSettings');
            
            settingsInputs.forEach(input => {
                input.addEventListener('change', function() {
                    settingsChanged = true;
                    saveSettingsBtn.disabled = false;
                });
            });
            
            saveSettingsBtn.addEventListener('click', function() {
                if (!settingsChanged) return;
                
                // Get selected settings
                const theme = document.querySelector('input[name="theme"]:checked').value;
                const density = document.querySelector('input[name="density"]:checked').value;
                const aiModel = document.querySelector('input[name="aiModel"]:checked').value;
                
                // Save to localStorage
                localStorage.setItem('promptcraft_settings', JSON.stringify({
                    theme,
                    density,
                    aiModel,
                    lastUpdated: new Date().toISOString()
                }));
                
                // Apply settings
                document.body.className = theme + '-theme';
                
                // Update model indicator
                const modelDisplayNames = {
                    'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                    'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                    'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                    'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                    'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                };
                document.getElementById('modelName').textContent = modelDisplayNames[aiModel] || 'Google Gemini 3 Flash Preview';
                
                // Reset state
                settingsChanged = false;
                saveSettingsBtn.disabled = true;
                
                // Close modal
                document.getElementById('closeSettings').click();
                
                showNotification('Settings saved successfully!', 'success');
            });
            
            document.getElementById('cancelSettings').addEventListener('click', function() {
                settingsChanged = false;
                saveSettingsBtn.disabled = true;
                document.getElementById('closeSettings').click();
            });
            
            // Settings modal controls
            document.getElementById('settingsBtn').addEventListener('click', function() {
                // Load saved settings
                const savedSettings = JSON.parse(localStorage.getItem('promptcraft_settings') || '{}');
                
                if (savedSettings.theme) {
                    document.querySelector(`input[name="theme"][value="${savedSettings.theme}"]`).checked = true;
                }
                if (savedSettings.density) {
                    document.querySelector(`input[name="density"][value="${savedSettings.density}"]`).checked = true;
                }
                if (savedSettings.aiModel) {
                    document.querySelector(`input[name="aiModel"][value="${savedSettings.aiModel}"]`).checked = true;
                }
                
                document.getElementById('settingsModal').style.display = 'block';
                document.body.classList.add('modal-open');
            });
            
            document.getElementById('closeSettings').addEventListener('click', function() {
                document.getElementById('settingsModal').style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            
            // FIX 10: History Navigation & Reusability
            document.getElementById('historyBtn').addEventListener('click', function() {
                document.getElementById('historySection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                loadHistoryWithReuse();
            });
            
            function loadHistoryWithReuse() {
                const historyList = document.getElementById('historyList');
                // This would be populated from your actual history manager
                // For now, we'll use sample data
                historyList.innerHTML = `
                    <div class="history-item">
                        <div class="history-item-content">
                            <div class="history-input">
                                <strong>Input:</strong> Create a marketing campaign for eco-friendly water bottles...
                            </div>
                            <div class="history-meta">
                                <span class="history-style">detailed</span>
                                <span class="history-time">10:30 AM</span>
                            </div>
                        </div>
                        <div class="history-item-actions">
                            <button class="history-item-reuse" title="Reuse this prompt">
                                <i class="fas fa-arrow-up"></i> Reuse
                            </button>
                            <button class="history-item-action" title="Delete from history">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-item-content">
                            <div class="history-input">
                                <strong>Input:</strong> Write Python code for data analysis...
                            </div>
                            <div class="history-meta">
                                <span class="history-style">concise</span>
                                <span class="history-time">09:15 AM</span>
                            </div>
                        </div>
                        <div class="history-item-actions">
                            <button class="history-item-reuse" title="Reuse this prompt">
                                <i class="fas fa-arrow-up"></i> Reuse
                            </button>
                            <button class="history-item-action" title="Delete from history">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Bind history item events
                document.querySelectorAll('.history-item-reuse').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const historyItem = this.closest('.history-item');
                        const inputText = historyItem.querySelector('.history-input').textContent.replace('Input:', '').trim();
                        
                        document.getElementById('userInput').value = inputText;
                        updateCharCount();
                        
                        // Scroll to Step 1
                        document.getElementById('step1').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        
                        // Focus on textarea
                        document.getElementById('userInput').focus();
                        
                        showNotification('Prompt loaded from history', 'success');
                    });
                });
                
                document.querySelectorAll('.history-item-action').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (confirm('Delete this history item?')) {
                            this.closest('.history-item').remove();
                            showNotification('History item deleted', 'success');
                        }
                    });
                });
            }
            
            function addToHistory(inputText, generatedPrompt, style) {
                // This would be handled by your actual history manager
                console.log('Adding to history:', { inputText, style });
            }
            
            // Clear history button
            document.getElementById('clearHistory').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all history?')) {
                    document.getElementById('historyList').innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-clock"></i>
                            <p>No history yet. Your prompts will appear here.</p>
                        </div>
                    `;
                    showNotification('History cleared', 'success');
                }
            });
            
            // Style buttons
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Copy prompt button
            document.getElementById('copyPrompt').addEventListener('click', function() {
                const promptText = document.querySelector('.prompt-text')?.textContent || 
                                 document.getElementById('generatedPrompt').textContent;
                
                if (promptText && !promptText.includes('Your generated prompt will appear here')) {
                    navigator.clipboard.writeText(promptText).then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                        showNotification('Prompt copied to clipboard!', 'success');
                    });
                }
            });
            
            // Helper functions
            function generateMockPrompt(input, style) {
                const styles = {
                    detailed: `You are an expert AI assistant. Based on the user request: "${input}"

Please create a comprehensive and detailed response that includes:

1. **Role Definition**: Specify the exact role you should embody
2. **Core Objective**: Clearly state the main goal
3. **Key Components**: Break down into essential elements
4. **Step-by-Step Process**: Provide actionable steps
5. **Best Practices**: Include industry standards and tips
6. **Expected Output**: Describe the final deliverable
7. **Quality Criteria**: List success metrics and evaluation criteria

Format the response in a structured, professional manner with clear headings and bullet points where appropriate.`,
                    
                    concise: `Task: ${input}

Provide a direct, focused response with clear, actionable instructions. Keep it brief but comprehensive.`,
                    
                    creative: `Creative Request: ${input}

Approach this with imagination and innovation. Use engaging language, incorporate storytelling elements, and focus on unique perspectives. Be inspiring and original in your response structure.`,
                    
                    professional: `Professional Assignment: ${input}

Prepare a formal, business-appropriate response structured as:

• Executive Summary
• Background Context
• Strategic Analysis
• Implementation Plan
• Risk Assessment
• Next Steps
• Success Metrics

Use professional tone and corporate formatting.`
                };
                
                return styles[style] || styles.detailed;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function showNotification(message, type = 'info') {
                // Simple notification for demo
                alert(message);
            }
            
            // Initialize
            updateCharCount();
            
            // Load saved settings
            const savedSettings = JSON.parse(localStorage.getItem('promptcraft_settings') || '{}');
            if (savedSettings.theme) {
                document.body.className = savedSettings.theme + '-theme';
            }
            if (savedSettings.aiModel) {
                const modelDisplayNames = {
                    'gemini-3-flash-preview': 'Google Gemini 3 Flash Preview',
                    'gpt-4o-mini': 'OpenAI GPT-4o Mini',
                    'llama-3.1-8b-instant': 'Meta Llama 3.1 8B (via Groq)',
                    'gemini-1.5-flash-latest': 'Google Gemini 1.5 Flash Latest',
                    'gemini-1.5-flash': 'Google Gemini 1.5 Flash'
                };
                document.getElementById('modelName').textContent = modelDisplayNames[savedSettings.aiModel] || 'Google Gemini 3 Flash Preview';
            }
            
            // Add progress bar if not exists
            if (!document.querySelector('.progress-indicator')) {
                const progressHTML = `
                    <div class="progress-indicator">
                        <div class="progress-bar" style="width: 33%"></div>
                    </div>
                `;
                const step1 = document.getElementById('step1');
                if (step1) {
                    step1.insertAdjacentHTML('afterend', progressHTML);
                }
            }
        });
    </script>

    <!-- Inline CSS for immediate fixes -->
    <style>
        /* Ensure proper modal stacking */
        .maximize-modal {
            z-index: 10000;
        }
        
        .modal-open .container {
            filter: blur(2px);
            pointer-events: none;
        }
        
        /* Quick fixes for immediate visibility */
        .btn-clear {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        /* Progress indicator */
        .progress-indicator {
            height: 3px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</body>
</html>
